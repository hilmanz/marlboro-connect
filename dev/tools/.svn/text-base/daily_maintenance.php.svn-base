<?phpinclude_once "/home/marlboro/config/config.inc.php";//include_once "../config/config.inc.php";//DATABASE CONFIGURATIONS$host = $CONFIG['DATABASE'][0]['HOST'];$user = $CONFIG['DATABASE'][0]['USERNAME'];$password = $CONFIG['DATABASE'][0]['PASSWORD'];$db = $CONFIG['DATABASE'][0]['DATABASE'];//------>print "Daily maintenance - ".date("Y-m-d H:i:s")."\n";print "----------------------------------------------\n";print "attempt to connect database : ";$conn = mysql_connect($host,$user,$password);if($conn){	print "OK\n";}else{	print "FAILED\n";}if($conn){	//1. Report Redeem	$sql = "TRUNCATE TABLE marlboro_code.report_redeem";	mysql_query($sql,$conn);	$sql = "INSERT INTO marlboro_code.report_redeem			SELECT bb.kode,aa.channel,aa.tier,bb.total FROM marlboro_code.badge_code aa 			INNER JOIN (SELECT kode,COUNT(kode) as total 			FROM marlboro_code.badge_redeem a			GROUP BY kode) bb			ON aa.kode = bb.kode";	$q = mysql_query($sql,$conn);		//query insert daily logins	$sql = "INSERT IGNORE INTO marlboro_code.report_dashboard_daily			(type,tanggal,total)			SELECT 1 as type,tgl,COUNT(tgl) as total FROM (SELECT user_id,'login' as activity,DATE(time) as tgl 			FROM marlboro_connect.social_tracking WHERE page LIKE '%login%') a			GROUP BY tgl			";	$q = mysql_query($sql,$conn);		//daily active users	$sql = "INSERT IGNORE INTO marlboro_code.report_dashboard_daily(type,tanggal,total)SELECT 2 as type,tgl,COUNT(tgl) as total FROM (SELECT user_id,tgl FROM (SELECT user_id,DATE(time) as tgl FROM marlboro_connect.social_trackingWHERE user_id > 0) aGROUP BY a.user_id,tgl) bGROUP BY b.tgl";	$q = mysql_query($sql,$conn);			//daily badge redeem	$sql = "INSERT IGNORE INTO marlboro_code.report_dashboard_daily(type,tanggal,total)SELECT 3 as type,tgl,COUNT(user_id) as total FROM (SELECT user_id,DATE(redeem_time) as tgl FROM marlboro_code.badge_redeem) aGROUP BY a.tgl";	$q = mysql_query($sql,$conn);		//daily trade completed	$sql = "INSERT IGNORE INTO marlboro_code.report_dashboard_daily(type,tanggal,total)SELECT 4 as type,tgl,COUNT(id) as total FROM (SELECT id,DATE(transaction_date) as tgl FROM marlboro_code.transaction_history) aGROUP BY a.tgl";	$q = mysql_query($sql,$conn);		//query insert daily actions	$sql = "INSERT IGNORE INTO marlboro_code.report_content_daily			(type,tanggal,total)			SELECT 1 as type,tgl,COUNT(tgl) as total FROM (SELECT DATE(time) as tgl 			FROM marlboro_connect.social_tracking) a			GROUP BY a.tgl";		$q = mysql_query($sql,$conn);		//query game plays	$sql = "INSERT IGNORE INTO marlboro_code.report_content_daily			(type,tanggal,total)			SELECT 2 as type,tgl,COUNT(tgl) FROM			(SELECT DATE(last_submit) as tgl 			FROM marlboro_connect.social_game WHERE level=1) a			GROUP BY a.tgl";		$q = mysql_query($sql,$conn);		//query badge redeem	$sql = "INSERT IGNORE INTO marlboro_code.report_content_daily			(type,tanggal,total)			SELECT 3 as type, tgl, COUNT(tgl) as total 			FROM (SELECT DATE(redeem_time) as tgl 			FROM marlboro_code.badge_redeem a			INNER JOIN marlboro_code.badge_code b			ON a.kode = b.kode) c			GROUP BY c.tgl";		$q = mysql_query($sql,$conn);		//query trade daily		//belum ada		//-->		//Badge traded total	$sql = "TRUNCATE TABLE marlboro_code.report_badge_traded";	$q = mysql_query($sql,$conn);		$sql = "INSERT INTO marlboro_code.report_badge_traded			SELECT need_id as badge_id,SUM(total) as subtotal FROM 			(SELECT need_id,COUNT(need_id) as total FROM marlboro_code.transaction_history a			INNER JOIN marlboro_code.auction_post b			ON a.auction_id1 = b.id			GROUP BY need_id			UNION ALL			SELECT need_id,COUNT(need_id) as total FROM marlboro_code.transaction_history a			INNER JOIN marlboro_code.auction_post b			ON a.auction_id2 = b.id			GROUP BY need_id) a			GROUP BY a.need_id";		$q = mysql_query($sql,$conn);	print mysql_error();	//-->		//trade activities summary	$sql = "SELECT COUNT(*) as total FROM marlboro_code.transaction_history";	$q = mysql_query($sql,$conn);		$total_trade = mysql_fetch_assoc($q);	mysql_free_result($q);	$sql = "SELECT COUNT(*) as total FROM marlboro_code.auction_post";	$q = mysql_query($sql,$conn);	$total_auction = mysql_fetch_assoc($q);	mysql_free_result($q);	//-->	$sql = "UPDATE marlboro_code.report_trade_summary SET trade_post = ".$total_auction['total'].",			trade_success=".$total_trade['total']."";	$q = mysql_query($sql,$conn);	//-->	//query merchandise redeemed	$sql = "INSERT IGNORE INTO marlboro_code.report_content_daily			(type,tanggal,total)			SELECT 5 as type,tgl,COUNT(tgl) as total FROM 			(SELECT DATE(request_date) as tgl 			FROM marlboro_code.merchandise_transaction) a			GROUP BY a.tgl";		$q = mysql_query($sql,$conn);		//content spread daily	$sql = "INSERT IGNORE INTO marlboro_code.report_content_spread			(page,tanggal,total)			SELECT page,tgl,COUNT(tgl) as total FROM 			(SELECT page,DATE(time) as tgl 			FROM marlboro_connect.social_tracking) a			GROUP BY page,tgl";		$q = mysql_query($sql,$conn);			//Query channel performance	$sql = "INSERT IGNORE INTO marlboro_code.report_channel_performance(channel,tgl,total)			SELECT channel,tgl,COUNT(tgl) as total FROM			(SELECT channel,DATE(redeem_time) as tgl			FROM marlboro_code.badge_redeem a			INNER JOIN marlboro_code.badge_code b			ON a.kode = b.kode) c			GROUP BY c.channel,c.tgl";	$q = mysql_query($sql,$conn);		//Surveyor Performance	$sql = "INSERT IGNORE INTO marlboro_code.report_surveyor_performance 			(tgl,surveyor,total)			SELECT tgl,surveyor,COUNT(tgl) as total FROM			(SELECT DATE(survey_date) as tgl,surveyor FROM marlboro_connect.ipad_code_registration) a			GROUP BY a.surveyor,a.tgl";		$q = mysql_query($sql,$conn);		//Query performance tiap2 channel;	$sql = "TRUNCATE TABLE marlboro_code.report_channel_redeem";	$q = mysql_query($sql,$conn);		$sql = "INSERT INTO marlboro_code.report_channel_redeem			(channel,subchannel,total)			SELECT channel,subchannel,COUNT(subchannel) as total FROM			(SELECT a.subchannel,b.kode,c.channel FROM marlboro_code.subchannel_lookup a			INNER JOIN marlboro_code.badge_redeem b			ON a.kode = b.kode			INNER JOIN marlboro_code.badge_code c			ON b.kode = c.kode) d			GROUP BY d.subchannel			";	$q = mysql_query($sql,$conn);		//report overall	//total code generated by dst	$sql = "SELECT COUNT(codeid) as total FROM marlboro_connect.ipad_code_registration";	$q = mysql_query($sql,$conn);		$total1 = mysql_fetch_assoc($q);	mysql_free_result($q);		$sql = "SELECT COUNT(codeid) as total FROM marlboro_connect.ipad_code_quiz";	$q = mysql_query($sql,$conn);		$total2 = mysql_fetch_assoc($q);	mysql_free_result($q);		$sql = "UPDATE marlboro_code.report_overall_total SET total = ".($total1['total']+$total2['total'])." WHERE name='dst_sba_generated'";	$q = mysql_query($sql,$conn);		//Total code redeemed from DST/SBA	//total code generated by dst	$sql = "SELECT COUNT(*) as total_redeemed 			FROM (SELECT b.kode FROM marlboro_connect.ipad_code_registration a			INNER JOIN marlboro_code.badge_redeem b			ON a.codeid = b.kode GROUP BY b.kode) c";	$q = mysql_query($sql,$conn);		$total1b = mysql_fetch_assoc($q);	mysql_free_result($q);		$sql = "SELECT COUNT(*) as total_redeemed 			FROM (SELECT b.kode FROM marlboro_connect.ipad_code_quiz a			INNER JOIN marlboro_code.badge_redeem b			ON a.codeid = b.kode GROUP BY b.kode) c";	$q = mysql_query($sql,$conn);		$total2b = mysql_fetch_assoc($q);	mysql_free_result($q);		$sql = "UPDATE marlboro_code.report_overall_total SET total = ".($total1b['total_redeemed']+$total2b['total_redeemed'])." WHERE name='dst_sba_redeemed'";	$q = mysql_query($sql,$conn);			//total participant	$sql = "SELECT COUNT(*) as total FROM (SELECT user_id FROM marlboro_code.badge_inventory GROUP BY user_id) a";	$q = mysql_query($sql,$conn);	$total3 = mysql_fetch_assoc($q);	mysql_free_result($q);	$sql = "UPDATE marlboro_code.report_overall_total SET total = ".($total3['total'])." WHERE name='total_participant'";	$q = mysql_query($sql,$conn);	//-->		//perolehan badge	$sql = "TRUNCATE TABLE marlboro_code.report_user_inventory";	$q = mysql_query($sql,$conn);		$sql = "SELECT user_id FROM marlboro_code.badge_inventory			GROUP BY user_id";	$q = mysql_query($sql,$conn);	$users = array();	while($fetch = mysql_fetch_assoc($q)){		$users[] = $fetch;	}	$fetch = null;	mysql_free_result($q);	print "Populating user inventory : \n";		foreach($users as $user){		$sql = "SELECT * FROM (SELECT a.register_id,a.name,a.last_name,b.badge_id,c.name as badge_name,b.total FROM marlboro_connect.social_member a				INNER JOIN (SELECT user_id,badge_id,COUNT(badge_id) as total 				FROM marlboro_code.badge_inventory WHERE user_id='".$user['user_id']."' GROUP BY user_id,badge_id) b				ON a.register_id = b.user_id				INNER JOIN marlboro_code.badge_catalog c				ON b.badge_id = c.id) d				ORDER BY d.name";				//print $sql."\n\n";		$q = mysql_query($sql,$conn);		$user_id = $user['user_id'];				$badge_1 = 0;		$badge_2 = 0;		$badge_3 = 0;		$badge_4 = 0;		$badge_5 = 0;		$badge_6 = 0;		$badge_7 = 0;		$badge_8 = 0;		$badge_9 = 0;		$badge_10 = 0;		$badge_11 = 0;		$badge_12 = 0;		$n=0;		while($fetch = mysql_fetch_assoc($q)){			$last_name = trim($fetch['last_name']);			if(strcmp($last_name,'Array')==0){				$last_name = '';			}			$name = $fetch['name']." ".$last_name;			if($fetch['badge_id']==1){				$badge_1+=$fetch['total'];			}			if($fetch['badge_id']==2){				$badge_2+=$fetch['total'];			}			if($fetch['badge_id']==3){				$badge_3+=$fetch['total'];			}			if($fetch['badge_id']==4){				$badge_4+=$fetch['total'];			}			if($fetch['badge_id']==5){				$badge_5+=$fetch['total'];			}			if($fetch['badge_id']==6){				$badge_6+=$fetch['total'];			}			if($fetch['badge_id']==7){				$badge_7+=$fetch['total'];			}			if($fetch['badge_id']==8){				$badge_8+=$fetch['total'];			}			if($fetch['badge_id']==9){				$badge_9+=$fetch['total'];			}			if($fetch['badge_id']==10){				$badge_10+=$fetch['total'];			}			if($fetch['badge_id']==11){				$badge_11+=$fetch['total'];			}			if($fetch['badge_id']==12){				$badge_12+=$fetch['total'];			}			$n++;		}		$fetch = null;		mysql_free_result($q);		if($n>0){			$sql = "INSERT INTO marlboro_code.report_user_inventory(register_id,name,badge_1,badge_2,					badge_3,badge_4,badge_5,badge_6,badge_7,badge_8,badge_9,badge_10,badge_11,badge_12)					VALUES('".$user_id."','".$name."',".$badge_1.",".$badge_2.",".$badge_3.",".$badge_4.",					".$badge_5.",".$badge_6.",".$badge_7.",".$badge_8.",".$badge_9.",".$badge_10.",					".$badge_11.",".$badge_12.")					";			//print $sql."\n\n";						$q = mysql_query($sql,$conn);			if($q){				print $user_id." --> OK\n";			}else{				print $user_id." --> Failed\n";			}		}	}	//clean up memory	$users = null;		//user game plays	$sql = "TRUNCATE TABLE marlboro_code.report_user_game";	$q = mysql_query($sql,$conn);		$sql = "SELECT user_id,name,last_name FROM marlboro_connect.social_game a 			INNER JOIN marlboro_connect.social_member b			ON a.user_id = b.register_id 			GROUP BY user_id";	$q = mysql_query($sql,$conn);	$users = array();	while($fetch = mysql_fetch_assoc($q)){		$users[] = $fetch;	}	$fetch = null;	mysql_free_result($q);		print "Populating User Game Plays : \n";	foreach($users as $user){		$user_id = $user['user_id'];				/*$sql = "SELECT a.user_id,b.name,b.last_name,a.game_id,COUNT(a.level) as total 				FROM marlboro_connect.social_game a				INNER JOIN marlboro_connect.social_member b				ON a.user_id = b.register_id				WHERE a.level=1 AND user_id='".$user_id."'				GROUP BY a.user_id,a.game_id";*/		$sql = "SELECT a.user_id,b.name,b.last_name,a.game_id,COUNT(a.game_id) as total 				FROM marlboro_connect.game_track a				INNER JOIN marlboro_connect.social_member b				ON a.user_id = b.register_id				WHERE a.user_id='".$user_id."'				GROUP BY a.user_id,a.game_id";		$q = mysql_query($sql,$conn);				$game_1 = 0;		$game_2 = 0;		$game_3 = 0;		$game_4 = 0;				$last_name = trim($user['last_name']);		if(strcmp($last_name,'Array')==0){				$last_name = '';		}		$name = $user['name']." ".$last_name;		$n=0;		while($fetch = mysql_fetch_assoc($q)){						if($fetch['game_id']==1){				$game_1+=$fetch['total'];			}			if($fetch['game_id']==2){				$game_2+=$fetch['total'];			}			if($fetch['game_id']==3){				$game_3+=$fetch['total'];			}			if($fetch['game_id']==4){				$game_4+=$fetch['total'];			}			$n++;					}		$fetch = null;		mysql_free_result($q);		if($n>0){			$sql = "INSERT INTO marlboro_code.report_user_game(register_id,name,game_1,game_2,					game_3,game_4)					VALUES('".$user_id."','".$name."',".$game_1.",".$game_2.",".$game_3.",".$game_4.")					";			$q = mysql_query($sql,$conn);			if($q){				print $user_id." --> OK\n";			}else{				print $user_id." --> Failed\n";			}		}	}	//-->	//clean up memory	$users = null;		print "Closing Database Connection ";		mysql_close($conn);	print "OK\n";}print "DONE\n---------------------------\n";?>